

:: # Get all currently open destination IP addresses and their process IDs
:: $ netstat -aon
:: # Get the query process ID's parent process ID (including the exited one)
:: $ (gwmi win32_process -Filter "processid='$my_pid'").ParentProcessId
:: # Get all Windows "Security" Event Logs
:: $ Get-EventLog -list       # Get the total number of logs
:: $ Get-EventLog Security  | Select *       # Get all logs
:: $ Get-EventLog Security -newest 10  | Select *       # Get 10 latest logs

@echo off
SETLOCAL DisableDelayedExpansion

set /p ip_list=<INPUT-BlacklistIP.txt
echo Blacklist IP: %ip_list%

:loop

echo Parent PID Updating...

::netstat -aon





netstat -aonp tcp | findstr %ip_list% > TEMP-connections.txt

del TEMP-connections-pid.txt
copy NUL TEMP-connections-pid.txt > nul
for /F "tokens=5 delims= " %%p in (TEMP-connections.txt) do (	
	echo %%p >> TEMP-connections-pid.txt
)

type TEMP-connections-pid.txt | sort /unique > TEMP-connections-pid-unique.txt

del TEMP-ppid-pre.txt
copy NUL TEMP-ppid-pre.txt > nul
for /F "tokens=1 delims= " %%p in (TEMP-connections-pid-unique.txt) do (	
	powershell -command "& {gwmi win32_process -Filter "processid='%%p'}" | findstr ParentProcessId >> TEMP-ppid-pre.txt
)

::del TEMP-ppid.txt
::copy NUL TEMP-ppid.txt


type TEMP-ppid-pre.txt | sort /unique > TEMP-ppid-pre-unique.txt

for /F "tokens=3 delims= " %%q in (TEMP-ppid-pre-unique.txt) do (	
	echo %%q >> TEMP-ppid.txt	
)

echo Parent PID Update Finished

type TEMP-ppid.txt | sort /unique > TEMP-ppid-update.txt

type TEMP-ppid-update.txt | sort /unique > TEMP-ppid.txt

timeout /t 1
goto loop
::netstat -aon 3600 | findstr %ip_list% > TEMP-connections.txt
	::.ParentProcessId
